
function MarkerClusterer(t,e,r){this.extend(MarkerClusterer,google.maps.OverlayView),this.map_=t,this.markers_=[],this.clusters_=[],this.sizes=[53,56,66,78,90],this.styles_=[],this.ready_=!1;var s=r||{};this.gridSize_=s.gridSize||60,this.minClusterSize_=s.minimumClusterSize||2,this.maxZoom_=s.maxZoom||null,this.styles_=s.styles||[],this.imagePath_=s.imagePath||this.MARKER_CLUSTER_IMAGE_PATH_,this.imageExtension_=s.imageExtension||this.MARKER_CLUSTER_IMAGE_EXTENSION_,this.zoomOnClick_=!0,null!=s.zoomOnClick&&(this.zoomOnClick_=s.zoomOnClick),this.averageCenter_=!1,null!=s.averageCenter&&(this.averageCenter_=s.averageCenter),this.setupStyles_(),this.setMap(t),this.prevZoom_=this.map_.getZoom();var i=this;google.maps.event.addListener(this.map_,"zoom_changed",function(){var t=i.map_.getZoom(),e=i.map_.minZoom||0,r=Math.min(i.map_.maxZoom||100,i.map_.mapTypes[i.map_.getMapTypeId()].maxZoom);t=Math.min(Math.max(t,e),r),i.prevZoom_!=t&&(i.prevZoom_=t,i.resetViewport())}),google.maps.event.addListener(this.map_,"idle",function(){i.redraw()}),e&&(e.length||Object.keys(e).length)&&this.addMarkers(e,!1)}function Cluster(t){this.markerClusterer_=t,this.map_=t.getMap(),this.gridSize_=t.getGridSize(),this.minClusterSize_=t.getMinClusterSize(),this.averageCenter_=t.isAverageCenter(),this.center_=null,this.markers_=[],this.bounds_=null,this.clusterIcon_=new ClusterIcon(this,t.getStyles(),t.getGridSize())}function ClusterIcon(t,e,r){t.getMarkerClusterer().extend(ClusterIcon,google.maps.OverlayView),this.styles_=e,this.padding_=r||0,this.cluster_=t,this.center_=null,this.map_=t.getMap(),this.div_=null,this.sums_=null,this.visible_=!1,this.setMap(this.map_)}MarkerClusterer.prototype.MARKER_CLUSTER_IMAGE_PATH_="../images/m",MarkerClusterer.prototype.MARKER_CLUSTER_IMAGE_EXTENSION_="png",MarkerClusterer.prototype.extend=function(t,e){return function(t){for(var e in t.prototype)this.prototype[e]=t.prototype[e];return this}.apply(t,[e])},MarkerClusterer.prototype.onAdd=function(){this.setReady_(!0)},MarkerClusterer.prototype.draw=function(){},MarkerClusterer.prototype.setupStyles_=function(){if(!this.styles_.length)for(var t,e=0;t=this.sizes[e];e++)this.styles_.push({url:this.imagePath_+(e+1)+"."+this.imageExtension_,height:t,width:t})},MarkerClusterer.prototype.fitMapToMarkers=function(){for(var t,e=this.getMarkers(),r=new google.maps.LatLngBounds,s=0;t=e[s];s++)r.extend(t.getPosition());this.map_.fitBounds(r)},MarkerClusterer.prototype.setStyles=function(t){this.styles_=t},MarkerClusterer.prototype.getStyles=function(){return this.styles_},MarkerClusterer.prototype.isZoomOnClick=function(){return this.zoomOnClick_},MarkerClusterer.prototype.isAverageCenter=function(){return this.averageCenter_},MarkerClusterer.prototype.getMarkers=function(){return this.markers_},MarkerClusterer.prototype.getTotalMarkers=function(){return this.markers_.length},MarkerClusterer.prototype.setMaxZoom=function(t){this.maxZoom_=t},MarkerClusterer.prototype.getMaxZoom=function(){return this.maxZoom_},MarkerClusterer.prototype.calculator_=function(t,e){for(var r=0,s=t.length,i=s;0!==i;)i=parseInt(i/10,10),r++;return{text:s,index:r=Math.min(r,e)}},MarkerClusterer.prototype.setCalculator=function(t){this.calculator_=t},MarkerClusterer.prototype.getCalculator=function(){return this.calculator_},MarkerClusterer.prototype.addMarkers=function(t,e){if(t.length)for(var r=0;s=t[r];r++)this.pushMarkerTo_(s);else if(Object.keys(t).length)for(var s in t)this.pushMarkerTo_(t[s]);e||this.redraw()},MarkerClusterer.prototype.pushMarkerTo_=function(t){if(t.isAdded=!1,t.draggable){var e=this;google.maps.event.addListener(t,"dragend",function(){t.isAdded=!1,e.repaint()})}this.markers_.push(t)},MarkerClusterer.prototype.addMarker=function(t,e){this.pushMarkerTo_(t),e||this.redraw()},MarkerClusterer.prototype.removeMarker_=function(t){var e=-1;if(this.markers_.indexOf)e=this.markers_.indexOf(t);else for(var r,s=0;r=this.markers_[s];s++)if(r==t){e=s;break}return-1!=e&&(t.setMap(null),this.markers_.splice(e,1),!0)},MarkerClusterer.prototype.removeMarker=function(t,e){var r=this.removeMarker_(t);return!(e||!r)&&(this.resetViewport(),this.redraw(),!0)},MarkerClusterer.prototype.removeMarkers=function(t,e){for(var r,s=!1,i=0;r=t[i];i++){var o=this.removeMarker_(r);s=s||o}if(!e&&s)return this.resetViewport(),this.redraw(),!0},MarkerClusterer.prototype.setReady_=function(t){this.ready_||(this.ready_=t,this.createClusters_())},MarkerClusterer.prototype.getTotalClusters=function(){return this.clusters_.length},MarkerClusterer.prototype.getMap=function(){return this.map_},MarkerClusterer.prototype.setMap=function(t){this.map_=t},MarkerClusterer.prototype.getGridSize=function(){return this.gridSize_},MarkerClusterer.prototype.setGridSize=function(t){this.gridSize_=t},MarkerClusterer.prototype.getMinClusterSize=function(){return this.minClusterSize_},MarkerClusterer.prototype.setMinClusterSize=function(t){this.minClusterSize_=t},MarkerClusterer.prototype.getExtendedBounds=function(t){var e=this.getProjection(),r=new google.maps.LatLng(t.getNorthEast().lat(),t.getNorthEast().lng()),s=new google.maps.LatLng(t.getSouthWest().lat(),t.getSouthWest().lng()),i=e.fromLatLngToDivPixel(r);i.x+=this.gridSize_,i.y-=this.gridSize_;var o=e.fromLatLngToDivPixel(s);o.x-=this.gridSize_,o.y+=this.gridSize_;var n=e.fromDivPixelToLatLng(i),a=e.fromDivPixelToLatLng(o);return t.extend(n),t.extend(a),t},MarkerClusterer.prototype.isMarkerInBounds_=function(t,e){return e.contains(t.getPosition())},MarkerClusterer.prototype.clearMarkers=function(){this.resetViewport(!0),this.markers_=[]},MarkerClusterer.prototype.resetViewport=function(t){for(var e,r=0;e=this.clusters_[r];r++)e.remove();var s;for(r=0;s=this.markers_[r];r++)s.isAdded=!1,t&&s.setMap(null);this.clusters_=[]},MarkerClusterer.prototype.repaint=function(){var r=this.clusters_.slice();this.clusters_.length=0,this.resetViewport(),this.redraw(),window.setTimeout(function(){for(var t,e=0;t=r[e];e++)t.remove()},0)},MarkerClusterer.prototype.redraw=function(){this.createClusters_()},MarkerClusterer.prototype.distanceBetweenPoints_=function(t,e){if(!t||!e)return 0;var r=(e.lat()-t.lat())*Math.PI/180,s=(e.lng()-t.lng())*Math.PI/180,i=Math.sin(r/2)*Math.sin(r/2)+Math.cos(t.lat()*Math.PI/180)*Math.cos(e.lat()*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 6371*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))},MarkerClusterer.prototype.addToClosestCluster_=function(t){for(var e,r=4e4,s=null,i=(t.getPosition(),0);e=this.clusters_[i];i++){var o=e.getCenter();if(o){var n=this.distanceBetweenPoints_(o,t.getPosition());n<r&&(r=n,s=e)}}s&&s.isMarkerInClusterBounds(t)?s.addMarker(t):((e=new Cluster(this)).addMarker(t),this.clusters_.push(e))},MarkerClusterer.prototype.createClusters_=function(){if(this.ready_)for(var t,e=new google.maps.LatLngBounds(this.map_.getBounds().getSouthWest(),this.map_.getBounds().getNorthEast()),r=this.getExtendedBounds(e),s=0;t=this.markers_[s];s++)!t.isAdded&&this.isMarkerInBounds_(t,r)&&this.addToClosestCluster_(t)},Cluster.prototype.isMarkerAlreadyAdded=function(t){if(this.markers_.indexOf)return-1!=this.markers_.indexOf(t);for(var e,r=0;e=this.markers_[r];r++)if(e==t)return!0;return!1},Cluster.prototype.addMarker=function(t){if(this.isMarkerAlreadyAdded(t))return!1;if(this.center_){if(this.averageCenter_){var e=this.markers_.length+1,r=(this.center_.lat()*(e-1)+t.getPosition().lat())/e,s=(this.center_.lng()*(e-1)+t.getPosition().lng())/e;this.center_=new google.maps.LatLng(r,s),this.calculateBounds_()}}else this.center_=t.getPosition(),this.calculateBounds_();t.isAdded=!0,this.markers_.push(t);var i=this.markers_.length;if(i<this.minClusterSize_&&t.getMap()!=this.map_&&t.setMap(this.map_),i==this.minClusterSize_)for(var o=0;o<i;o++)this.markers_[o].setMap(null);return i>=this.minClusterSize_&&t.setMap(null),this.updateIcon(),!0},Cluster.prototype.getMarkerClusterer=function(){return this.markerClusterer_},Cluster.prototype.getBounds=function(){for(var t,e=new google.maps.LatLngBounds(this.center_,this.center_),r=this.getMarkers(),s=0;t=r[s];s++)e.extend(t.getPosition());return e},Cluster.prototype.remove=function(){this.clusterIcon_.remove(),this.markers_.length=0,delete this.markers_},Cluster.prototype.getSize=function(){return this.markers_.length},Cluster.prototype.getMarkers=function(){return this.markers_},Cluster.prototype.getCenter=function(){return this.center_},Cluster.prototype.calculateBounds_=function(){var t=new google.maps.LatLngBounds(this.center_,this.center_);this.bounds_=this.markerClusterer_.getExtendedBounds(t)},Cluster.prototype.isMarkerInClusterBounds=function(t){return this.bounds_.contains(t.getPosition())},Cluster.prototype.getMap=function(){return this.map_},Cluster.prototype.updateIcon=function(){var t=this.map_.getZoom(),e=this.markerClusterer_.getMaxZoom();if(e&&e<t)for(var r,s=0;r=this.markers_[s];s++)r.setMap(this.map_);else if(this.markers_.length<this.minClusterSize_)this.clusterIcon_.hide();else{var i=this.markerClusterer_.getStyles().length,o=this.markerClusterer_.getCalculator()(this.markers_,i);this.clusterIcon_.setCenter(this.center_),this.clusterIcon_.setSums(o),this.clusterIcon_.show()}},ClusterIcon.prototype.triggerClusterClick=function(){var t=this.cluster_.getMarkerClusterer();google.maps.event.trigger(t,"clusterclick",this.cluster_),t.isZoomOnClick()&&this.map_.fitBounds(this.cluster_.getBounds())},ClusterIcon.prototype.onAdd=function(){if(this.div_=document.createElement("DIV"),this.visible_){var t=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(t),this.div_.innerHTML=this.sums_.text}this.getPanes().overlayMouseTarget.appendChild(this.div_);var e=this;google.maps.event.addDomListener(this.div_,"click",function(){e.triggerClusterClick()})},ClusterIcon.prototype.getPosFromLatLng_=function(t){var e=this.getProjection().fromLatLngToDivPixel(t);return e.x-=parseInt(this.width_/2,10),e.y-=parseInt(this.height_/2,10),e},ClusterIcon.prototype.draw=function(){if(this.visible_){var t=this.getPosFromLatLng_(this.center_);this.div_.style.top=t.y+"px",this.div_.style.left=t.x+"px"}},ClusterIcon.prototype.hide=function(){this.div_&&(this.div_.style.display="none"),this.visible_=!1},ClusterIcon.prototype.show=function(){if(this.div_){var t=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(t),this.div_.style.display=""}this.visible_=!0},ClusterIcon.prototype.remove=function(){this.setMap(null)},ClusterIcon.prototype.onRemove=function(){this.div_&&this.div_.parentNode&&(this.hide(),this.div_.parentNode.removeChild(this.div_),this.div_=null)},ClusterIcon.prototype.setSums=function(t){this.sums_=t,this.text_=t.text,this.index_=t.index,this.div_&&(this.div_.innerHTML=t.text),this.useStyle()},ClusterIcon.prototype.useStyle=function(){var t=Math.max(0,this.sums_.index-1);t=Math.min(this.styles_.length-1,t);var e=this.styles_[t];this.url_=e.url,this.height_=e.height,this.width_=e.width,this.textColor_=e.textColor,this.anchor_=e.anchor,this.textSize_=e.textSize,this.backgroundPosition_=e.backgroundPosition},ClusterIcon.prototype.setCenter=function(t){this.center_=t},ClusterIcon.prototype.createCss=function(t){var e=[];e.push("background-image:url("+this.url_+");");var r=this.backgroundPosition_?this.backgroundPosition_:"0 0";e.push("background-position:"+r+";"),"object"==typeof this.anchor_?("number"==typeof this.anchor_[0]&&0<this.anchor_[0]&&this.anchor_[0]<this.height_?e.push("height:"+(this.height_-this.anchor_[0])+"px; padding-top:"+this.anchor_[0]+"px;"):e.push("height:"+this.height_+"px; line-height:"+this.height_+"px;"),"number"==typeof this.anchor_[1]&&0<this.anchor_[1]&&this.anchor_[1]<this.width_?e.push("width:"+(this.width_-this.anchor_[1])+"px; padding-left:"+this.anchor_[1]+"px;"):e.push("width:"+this.width_+"px; text-align:center;")):e.push("height:"+this.height_+"px; line-height:"+this.height_+"px; width:"+this.width_+"px; text-align:center;");var s=this.textColor_?this.textColor_:"black",i=this.textSize_?this.textSize_:11;return e.push("cursor:pointer; top:"+t.y+"px; left:"+t.x+"px; color:"+s+"; position:absolute; font-size:"+i+"px; font-family:Arial,sans-serif; font-weight:bold"),e.join("")};const pickupSitesOscop=(function pickupSites(){const vars={selector:'#pickup-sites__map',isCod:false,getNearest:1,cityPickup:[],selectClass:'f-dropdown f-group f-select --placeholder',dropdownCallbackCity:($elem)=>{app_shop.fn.clickDropdown($elem);},dropdownCallbackPoint:($elem)=>{app_shop.fn.clickDropdown($elem);},googleMapsLoaded:false,...app_shop.vars.pickupSitesOptions,};const txt={pickupl_alert:"Geen ophaalpunt geselecteerd",pickupl_linktxt:"meer informatie",pickupl_linktitle:"Zie details",pickupl_requires_client_number:"Het klantnummer is niet ingevoerd in het koerierssysteem.",pickupl_select_adress:"Voer het juiste adres in.",pickupl_select_route:"Voer de naam van de stad in",pickupl_nopoints:"Geef een ander adres op, geen afhaalpunten.",pickupl_error:"Er is een fout opgetreden. Vernieuw de pagina en probeer het opnieuw",pickupl_nopoints_in_area:"Geen verzamelpunten gevonden in het gebied. ",pickupl_choose_city:"Selecteer een stad",pickupl_choose_pickup:"Selecteer een verzamelpunt",pickupl_additional_info:"Aanvullende informatie over het verzamelpunt:",};const alpha=(alphabet,dir,caseSensitive)=>{return(a,b)=>{let pos=0;const min=Math.min(a.length,b.length);dir=dir||1;caseSensitive=caseSensitive||false;if(!caseSensitive){a=a.toLowerCase();b=b.toLowerCase();}
while(a.charAt(pos)===b.charAt(pos)&&pos<min){pos++;}
return alphabet.indexOf(a.charAt(pos))>alphabet.indexOf(b.charAt(pos))?dir:-dir;};};const alphaPickup=(alphabet,dir,caseSensitive)=>{return(a,b)=>{let pos=0;const min=Math.min(a[0].length,b[0].length);dir=dir||1;caseSensitive=caseSensitive||false;if(!caseSensitive){a=a[0].toLowerCase();b=b[0].toLowerCase();}
while(a[0].charAt(pos)===b[0].charAt(pos)&&pos<min){pos++;}
return alphabet.indexOf(a[0].charAt(pos))>alphabet.indexOf(b[0].charAt(pos))?dir:-dir;};};const pickuppointInfo=(elem)=>{const{selector}=vars;const wrapper=$(selector);const obj=elem.find('a');$('.pickup-sites__info').remove();if(obj.data('title')){wrapper.append(`<div class="pickup-sites__info --small"><strong>${txt.pickupl_additional_info}</strong>${obj.data('title').replace(/nbsp/g,' ')}</div>`);}};const pickuppointCity=(elem)=>{const obj=elem.find('a');const{selector}=vars;const wrapper=$(selector);wrapper.find('.f-select.--pickup_point').remove();$('.pickup-sites__info').remove();const paymentID=obj.data('value').split('#')[0];const cityName=obj.data('value').split('#')[1];if(vars.cityPickup[paymentID]&&vars.cityPickup[paymentID][cityName]){let pickups=vars.cityPickup[paymentID][cityName];pickups=pickups.sort(alphaPickup('01234567989aąbcćdeęfghijklłmnńoóprsśtuwyzźż'));let select=`<select class="${vars.selectClass} --pickup_point"value=""name="pickup_point"required data-create_order="pickup_point">`;select+=`<option value="">${txt.pickupl_choose_pickup}</option>`;for(let i=0;i<pickups.length;i++){const info=pickups[i][2]
select+=`<option data-title="${info.replace(/ /g,'nbsp')}"value="${pickups[i][1]}">${pickups[i][0]},${pickups[i][1]}</option>`;}
select+='</select>';wrapper.append(select);app_shop.fn.dropdown($('#pickup-sites__map .f-select.--pickup_point'),'pickup_point',($elem)=>{vars.dropdownCallbackPoint($elem);pickuppointInfo($elem);});$('#pickup-sites__map .f-select.--pickup_point input[name="pickup_point"]').attr('data-create_order','pickup_point');}};const alternativePickup=(courierId)=>{const{isCod,getNearest,selector}=vars;const wrapper=$(selector);$('.pickup-sites').addClass('--small');oscop.getPickups({courierId,isCod,getNearest}).then((data)=>{const json=data[0];if(!vars.cityPickup[courierId]){vars.cityPickup[courierId]=[];}
const pickupCount=json.pickupPoints.length;if(pickupCount===1){wrapper.append(`<input type="hidden"name="pickup_point"value="${json.pickupPoints[0].id}"data-create_order="pickup_point">`);oscop.vars.pickupPoint=json.pickupPoints[0].id;$('.delivery__point').remove();$('input[name="shipping"]:checked + label .delivery__name').append(`<i class="delivery__point">${oscop.vars.pickupPoint}</i>`);oscop.toplayer(false);return false;}
for(let i=0;i<json.pickupPoints.length;i++){if(!vars.cityPickup[courierId][json.pickupPoints[i].address.city]){vars.cityPickup[courierId][json.pickupPoints[i].address.city]=[];}
vars.cityPickup[courierId][json.pickupPoints[i].address.city].push([`${json.pickupPoints[i].address.street}&#32;${json.pickupPoints[i].address.buildingAndHouseNumber}`,json.pickupPoints[i].id,json.pickupPoints[i].location,json.pickupPoints[i].coordinates,json.pickupPoints[i].address.city,]);}
let cityNames=[];for(let city in vars.cityPickup[courierId]){if(vars.cityPickup[courierId].hasOwnProperty(city)){cityNames.push(city);}}
cityNames=cityNames.sort(alpha('01234567989aąbcćdeęfghijklłmnńoóprsśtuwyzźż'));wrapper.html('');let select=`<select class="${vars.selectClass} --pickup_city"value=""name="pickup_city"required>`;select+=`<option value="">${txt.pickupl_choose_city}</option>`;for(let i in cityNames){if(cityNames.hasOwnProperty(i)){select+=`<option value="${courierId}#${cityNames[i]}">${cityNames[i]}</option>`;}}
select+='</select>';wrapper.append(select);app_shop.fn.dropdown($('#pickup-sites__map .f-select.--pickup_city'),'pickup_city',($elem)=>{vars.dropdownCallbackCity($elem);pickuppointCity($elem)});oscop.toplayer({show:true,selector:'.pickup-sites'});return true;});};const mapPickup=(courier)=>{const mapVars={geokoder:0,mapa:0,markersArray:[],markerInfo:0,timeout:0,pickupCount:0,pickupIteration:0,pickupFind:0,calendar:{},markerAnimation:0,google_api_key:app_shop.vars.googleApiKey,courierId:courier||$('input[name=shipping]:checked').val(),isCod:vars.isCod,search_lat:'',search_lng:'',markerClusters:'',ClusterMaxZoom:13,minimumClusterSize:10,autocomplete:false,copAdress:$('#pickup-sites__autocomplete').val()||'',adress:{street_number:'',route:'',locality:'',administrative_area_level_1:'',country:'',postal_code:''},...app_shop.vars.mapPickupOptions,};const pickupAlert=(message)=>{$('.pickup-sites__aside_container .menu_messages_message').remove();$('.pickup-sites__aside_container').prepend(`<div class="menu_messages_message">${message}</div>`);}
const fillInAddress=(place,manual)=>{mapVars.adress={street_number:'',route:'',locality:'',administrative_area_level_1:'',country:'',postal_code:''};var componentForm={street_number:'short_name',route:'long_name',locality:'long_name',administrative_area_level_1:'short_name',country:'long_name',postal_code:'short_name'};mapVars.search_lat='';mapVars.search_lng='';if(place&&!place.geometry)return false;if(!place){if(mapVars.courierId=='')return false;pickupAlert(txt.pickupl_select_adress);$('.pickup-sites__row, .loadingMap').hide();return false;}else{$('.pickup-sites__map__container, .pickup-sites__aside_container, .pickup-sites__row').show();}
mapVars.search_lat=place.geometry.location.lat();mapVars.search_lng=place.geometry.location.lng();for(var i=0;i<place.address_components.length;i++){var addressType=place.address_components[i].types[0];if(componentForm[addressType]){var val=place.address_components[i][componentForm[addressType]];mapVars.adress[addressType]=val;}}
if(manual){var inputValue='';if(mapVars.adress.route){inputValue+=mapVars.adress.route;if(mapVars.adress.street_number){inputValue+=' '+mapVars.adress.street_number;}}
if(mapVars.adress.locality){if(mapVars.adress.route){inputValue+=', '}
inputValue+=mapVars.adress.locality;}
if(mapVars.adress.country){if(mapVars.adress.locality){inputValue+=', '}
inputValue+=mapVars.adress.country;}
$('#pickup-sites__autocomplete').val(inputValue);}};const getLocation=()=>{if(mapVars.search_lat==''&&mapVars.search_lng==''){$('#pickup-sites__autocomplete').val(mapVars.copAdress);mapVars.geokoder.geocode({address:$('#pickup-sites__autocomplete').val()},function(json,status){var point=(json&&json.length)?json[0]:null;fillInAddress(point,true);ajaxGetPickup();return false;});}
ajaxGetPickup();};const ajaxGetPickup=()=>{if(mapVars.courierId=='')return false;if(!mapVars.adress.locality){pickupAlert(txt.pickupl_select_adress);$('.pickup-sites__row, .loadingMap').hide();return false;}else{$('.pickup-sites__map__container, .pickup-sites__aside_container, .pickup-sites__row').show();}
$('label.pickup_point').hide();$('div.loadingMap').fadeIn('normal',()=>{});$('span.loadingMarkers').hide();const options={'courierId':mapVars.courierId,'location[latitude]':mapVars.search_lat,'location[longitude]':mapVars.search_lng,'isCod':mapVars.isCod};oscop.getPickups(options).then((data)=>{const json=data[0]
if(!json.pickupPoints.length){pickupAlert(txt.pickupl_nopoints);return false;}
if(!mapVars.adress.route){for(i in json.pickupPoints){if($.trim(json.pickupPoints[i].address.city).toLowerCase()==$.trim(mapVars.adress.locality).toLowerCase()){options.radius=30;oscop.getPickups(options).then((data)=>{const json=data[0]
setPickupPoints(json,true);}).catch(()=>{})
return false;}}}
setPickupPoints(json,false);}).catch(()=>{Alertek.Start(txt.pickupl_error);})};const showSel=()=>{mapVars.pickupCount=$('.pickup-sites__aside_container .pickup_point').length;mapVars.pickupIteration=0;$('div.loadingMap').fadeIn('normal',()=>{});$('span.loadingMap').hide();$('span.loadingMarkers').css('display','block');$('span.loadingMarkersCount').text(mapVars.pickupCount);$('span.loadingMarkersComplete').text(mapVars.pickupIteration);mapVars.markersArray=[];const adresData=[]
$('.pickup-sites__aside_container .pickup_point').each((index,item)=>{$this=$(item);adresData[index]={};adresData[index].idek=$this.data("id");adresData[index].headerText=$.trim($this.find(".headerText").text());adresData[index].streetText=$.trim($this.find(".streetText").text());adresData[index].cityText=$.trim($this.find(".cityText").text());adresData[index].moreText=$.trim($this.find(".moreLink").text());adresData[index].moreLink=$.trim($this.find(".moreLink").attr('href'));adresData[index].infoText=$.trim($this.find(".infoText").text());adresData[index].timeText=$.trim($this.find(".timeText").text());adresData[index].latitude=$.trim($this.data("latitude"));adresData[index].longitude=$.trim($this.data("longitude"));adresData[index].icon=$.trim($this.data('icon'));});let adresRow='';while(adresRow=adresData.pop()){if(adresRow.latitude&&adresRow.longitude){findAdres(adresRow.headerText,adresRow.streetText,adresRow.cityText,adresRow.moreText,adresRow.moreLink,adresRow.infoText,adresRow.timeText,'none','another',false,adresRow.idek,adresRow.latitude,adresRow.longitude,adresRow.icon);}else{((adresRow)=>{setTimeout(()=>{findAdres(adresRow.headerText,adresRow.streetText,adresRow.cityText,adresRow.moreText,adresRow.moreLink,adresRow.infoText,adresRow.timeText,'none','another',false,adresRow.idek,adresRow.latitude,adresRow.longitude,adresRow.icon);},mapVars.timeout);})(adresRow);}}};const printDates=(stockId)=>{if(!$('#selectPickupDay').size()){return false;}
const options={stock_id:stockId};oscop.getBasketDelivery(options).then((data)=>{const json=data[0];if(!json){$('#selectPickupDayWrapper').hide();$('.pickupl_hour_wrapper').hide();return false};$('#selectPickupDay').html('');$.each(json,function(index,data){$('#selectPickupDay').append(`<label class="pickupl_date"><input name="calendar_select_date"type="radio"class="pickupl_radio"value="${data.date}"></input><div class="pickupl_date_sub"><span class="pickupl_date_day">${data.d}</span><span class="pickupl_date_month">${iaical_monthNames[data.m-1]}</span></div></label>`);});$('#selectPickupDayWrapper').show();$('.pickupl_hour_wrapper').show();$('#selectPickupDay [name="calendar_select_date"]').eq(1).attr('checked',true);}).catch(()=>{Alertek.Start(txt.pickupl_error);})};const setZoom=()=>{const bounds=new google.maps.LatLngBounds();for(let i in mapVars.markersArray){bounds.extend(mapVars.markersArray[i].getPosition());}
mapVars.mapa.setCenter(bounds.getCenter());mapVars.mapa.fitBounds(bounds);mapVars.mapa.setZoom(mapVars.mapa.getZoom());if(mapVars.mapa.getZoom()>15){mapVars.mapa.setZoom(15);}};const mapInit=()=>{if($('#pickup-sites__autocomplete').size()){mapVars.autocomplete=new google.maps.places.Autocomplete((document.getElementById('pickup-sites__autocomplete')));$('label.pickup_point').hide();}
if(mapVars.google_api_key===''){$('.pickupl_sel').removeAttr('disabled');$('div#ps_other').css('opacity','1.0');$('div#ps_other').css('cursor','pointer');}
mapVars.geokoder=new google.maps.Geocoder();mapVars.mapa=new google.maps.Map(document.getElementById("pickup_map"),{gestureHandling:'cooperative',zoom:mapVars.zoom,center:new google.maps.LatLng(52,19.5),mapTypeId:google.maps.MapTypeId.ROADMAP,navigationControl:true,mapTypeControl:true,scaleControl:false,navigationControlOptions:{style:google.maps.NavigationControlStyle.ZOOM_PAN},mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},...app_shop.vars.mapOptions,});mapVars.markerInfo=new google.maps.InfoWindow();google.maps.event.addListener(mapVars.mapa,'idle',function(){$('span.loadingMap').text($('span.loadingNav').text());});if(mapVars.autocomplete){mapVars.autocomplete.addListener('place_changed',function(){var place=mapVars.autocomplete.getPlace();fillInAddress(place,false);});getLocation();}else{showSel();}};const geokoderPrepare=(point,status,headerText,streetText,cityText,moreText,moreLink,infoText,timeText,className,other,open,idek,latitude,longitude,icon)=>{if(status==google.maps.GeocoderStatus.OK){mapVars.timeout=100;mapVars.pickupIteration++;mapVars.pickupFind++;let content=`<div class="mapTooltip"><b class="mapTooltipName">${headerText}</b><div class="mapTooltipAdress"><span>${streetText}</span><span>${cityText}</span></div>${infoText?`<div class="mapTooltipComment">${infoText}</div>`:''}<div class="mapTooltipTime">${timeText}</div>${moreLink?`<div class="mapTooltipLink"><a class="btn-small"title=""href="${moreLink}"target="_blank">${moreText}</a></div>`:''}</div>`;const markerOptions={title:headerText,pickupPointID:idek,position:point,map:mapVars.mapa};if(mapVars.markerAnimation)
markerOptions.animation=google.maps.Animation.DROP;const marker=new google.maps.Marker(markerOptions);mapVars.markersArray.push(marker);google.maps.event.addListener(marker,'click',((marker,i)=>{return function(e){e.cancelBubble=true;e.returnValue=false;if(e.stopPropagation){e.stopPropagation();e.preventDefault();}
mapVars.markerInfo.setContent(content);mapVars.markerInfo.open(mapVars.mapa,marker);$('.pickup-sites__aside_container [value="'+marker.pickupPointID+'"]').attr('checked',true);$('.pickup-sites__aside_container').scrollTop(0);$('.pickup-sites__aside_container').scrollTop($('#place-order__pickup-sites [name="pickup_point"]:checked + label').position().top);}})(marker,i));const pickupItem=$('.pickup-sites__aside_container [value="'+marker.pickupPointID+'"]').get(0);$('label[for="pickup_point_'+marker.pickupPointID+'"]').show().fadeTo('slow',1);google.maps.event.addDomListener(pickupItem,'click',((marker,i)=>{return function(e){$('.pickup-sites__aside_container [value="'+marker.pickupPointID+'"]').attr('checked',true);mapVars.markerInfo.setContent(content);mapVars.mapa.setCenter(markerOptions.position);if(mapVars.mapa.getZoom()<mapVars.ClusterMaxZoom){mapVars.mapa.setZoom(mapVars.ClusterMaxZoom+1);}
mapVars.markerInfo.open(mapVars.mapa,marker);}})(marker,i));if(mapVars.pickupIteration<mapVars.pickupCount){$('span.loadingMarkersComplete').text(mapVars.pickupIteration);}
if(mapVars.pickupIteration>=mapVars.pickupCount){setTimeout(()=>{$('div.loadingMap').fadeOut('normal',()=>{});const _src=$('.markerCluster[src*="m1.png"]').attr('src')
const _imagePath=_src.substring(0,_src.indexOf('1.png'));if(!mapVars.markerClusters){mapVars.markerClusters=new MarkerClusterer(mapVars.mapa,mapVars.markersArray,{imagePath:_imagePath,maxZoom:mapVars.ClusterMaxZoom,minimumClusterSize:mapVars.minimumClusterSize});}else{mapVars.markerClusters.clearMarkers()
mapVars.markerClusters.addMarkers(mapVars.markersArray);}
setZoom();},300);}}else if(status==google.maps.GeocoderStatus.OVER_QUERY_LIMIT){mapVars.timeout+=50;setTimeout(()=>{findAdres(headerText,streetText,cityText,moreText,moreLink,infoText,timeText,className,other,open,idek,latitude,longitude,icon);},mapVars.timeout);}else{mapVars.pickupIteration++;if(mapVars.pickupIteration<=mapVars.pickupCount)
$('span.loadingMarkersComplete').text(mapVars.pickupIteration);if(mapVars.pickupIteration>=mapVars.pickupCount){setTimeout(()=>{$('div.loadingMap').fadeOut('normal',()=>{});const _src=$('.markerCluster[src*="m1.png"]').attr('src')
const _imagePath=_src.substring(0,_src.indexOf('1.png')-1);if(!mapVars.markerClusters){mapVars.markerClusters=new MarkerClusterer(mapVars.mapa,mapVars.markersArray,{imagePath:_imagePath,maxZoom:mapVars.ClusterMaxZoom,minimumClusterSize:mapVars.minimumClusterSize});}else{mapVars.markerClusters.clearMarkers()
mapVars.markerClusters.addMarkers(mapVars.markersArray);}
setZoom();},300);}}};const findAdres=(headerText,streetText,cityText,moreText,moreLink,infoText,timeText,className,other,open,idek,latitude,longitude,icon)=>{var adres=`${streetText},${cityText}`;if(latitude&&longitude){var point=new google.maps.LatLng(latitude,longitude);geokoderPrepare(point,'OK',headerText,streetText,cityText,moreText,moreLink,infoText,timeText,className,other,open,idek,latitude,longitude,icon);}else{mapVars.geokoder.geocode({address:adres},(results,status)=>{var point=(results&&results.length)?results[0].geometry.location:null;geokoderPrepare(point,status,headerText,streetText,cityText,moreText,moreLink,infoText,timeText,className,other,open,idek,latitude,longitude,icon);});}};const geolocate=()=>{mapVars.search_lat='';mapVars.search_lng='';if(navigator.geolocation){navigator.geolocation.getCurrentPosition((position)=>{const geolocation={lat:position.coords.latitude,lng:position.coords.longitude};const circle=new google.maps.Circle({center:geolocation,radius:position.coords.accuracy});mapVars.autocomplete.setBounds(circle.getBounds());});}};const setPickupPoints=(json,filter)=>{if(!$.isEmptyObject(mapVars.markersArray)){for(i in mapVars.markersArray){mapVars.markersArray[i].setMap(null);}}
$('#place-order__pickup-sites .pickup-sites__aside_container').html('');if(filter){const pickupPointsFilter=[];for(i in json.pickupPoints){if($.trim(json.pickupPoints[i].address.city).toLowerCase()==$.trim(mapVars.adress.locality).toLowerCase()){pickupPointsFilter.push(json.pickupPoints[i]);}}
if(pickupPointsFilter.length){json.pickupPoints=pickupPointsFilter;}}
for(i in json.pickupPoints){const pickup=json.pickupPoints[i];const pickup_clone=$('#pickup_copy').clone();pickup_clone.find('input[name=pickup_point]').attr('id',`pickup_point_${pickup.id}`);pickup_clone.find('input[name=pickup_point]').attr('data-create_order','pickup_point');pickup_clone.find('input[name=pickup_point]').val(pickup.id);if(pickup.id===oscop.vars.pickupPoint)
pickup_clone.find('input[name=pickup_point]').prop('checked',true);pickup_clone.find('label').attr('data-latitude',pickup.coordinates.latitude);pickup_clone.find('label').attr('data-longitude',pickup.coordinates.longitude);pickup_clone.find('label').attr('data-id',pickup.id);pickup_clone.find('label').attr('data-requires_client_number',pickup.requiresClientNumber);pickup_clone.find('label').attr('for','pickup_point_'+pickup.id);pickup_clone.find('label').show();if(pickup.markerIconUrl){pickup_clone.find('label').attr('data-icon',pickup.markerIconUrl);pickup_clone.find('label').find('svg').replaceWith('<img src="'+pickup.markerIconUrl+'" alt="'+pickup.id+'"/>');}
if(pickup.coordinates.longitude){pickup_clone.find('label .map_dir').attr('href','https://www.google.com/maps/dir/?api=1&destination='+pickup.coordinates.latitude+','+pickup.coordinates.longitude);}else{pickup_clone.find('label .map_dir').attr('href','https://maps.google.com?saddr=Current+Location&daddr='+pickup.address.street+'+'+pickup.address.postcode+'+'+pickup.address.city);}
pickup_clone.find('b.headerText').text(pickup.name);const pickup_street=pickup.address.buildingAndHouseNumber!=''&&pickup.address.buildingAndHouseNumber!=null?pickup.address.street+' '+pickup.address.buildingAndHouseNumber:pickup.address.street;pickup_clone.find('span.streetText').text(pickup_street);pickup_clone.find('span.zipcodePickup').html(pickup.address.postcode+' <span class="cityText">'+pickup.address.city+'</span>');pickup_clone.find('div.moreText').text(pickup.location);pickup_clone.find('a.moreLink').attr('href',pickup.link);if(pickup.requiresClientNumber){}else{pickup_clone.find('input[name=client_courier_number]').remove();}
$('#place-order__pickup-sites .pickup-sites__aside_container').append(pickup_clone.find(' > *'));}
showSel();};$(document).off('click','#pickup-sites__search .btn').on('click','#pickup-sites__search .btn',()=>{getLocation();return false;});$(document).off('click','div.morePickup').on('click','div.morePickup',function morePickupClick(){const activePoints=$('label.pickup_point.moreInfoShow')
$(this).parents('label.pickup_point').addClass('moreInfoShow');activePoints.removeClass('moreInfoShow');});$(document).off('click','#place-order__pickup-sites [name="pickup_point"], #place-order__pickup-sites [name="stock"]').on('click','#place-order__pickup-sites [name="pickup_point"], #place-order__pickup-sites [name="stock"]',function pickupPointClick(){$('#place-order__pickup-sites [name="client_courier_number"]').attr('disabled',true);$(this).find('+ label [name="client_courier_number"]').attr('disabled',false).focus();printDates($(this).val());});$(document).off('focus','#pickup-sites__autocomplete').on('focus','#pickup-sites__autocomplete',()=>{geolocate();}).off('keyup','#pickup-sites__autocomplete').on('keyup','#pickup-sites__autocomplete',(e)=>{if(e.keyCode===13){e.preventDefault();mapVars.geokoder.geocode({address:$('#pickup-sites__autocomplete').val()},function(json,status){var point=(json&&json.length)?json[0]:null;fillInAddress(point,true);ajaxGetPickup();return false;});return false;}});mapInit();oscop.toplayer({show:true,selector:'.pickup-sites'});}
const init=(courierId)=>{if(!app_shop.vars.googleApiKey){alternativePickup(courierId);$(document).on('click','.pickup-sites__choose_button',function choosePickupAlternative(){oscop.vars.pickupPoint=$('input[name="pickup_point"]').val();$('.delivery__point').remove();$('input[name="shipping"]:checked + label .delivery__name').append(`<i class="delivery__point">${oscop.vars.pickupPoint}</i>`);oscop.toplayer(false);});return false;}
if(vars.googleMapsLoaded){mapPickup(courierId);}else{$.getScript('https://maps.googleapis.com/maps/api/js?key='+app_shop.vars.googleApiKey+'&libraries=places').done((script,textStatus)=>{vars.googleMapsLoaded=true;mapPickup(courierId);});}
$(document).on('click','.pickup-sites__choose_button',function choosePickup(){oscop.vars.pickupPoint=$('input[name="pickup_point"]:checked').val();$('.delivery__point').remove();$('input[name="shipping"]:checked + label .delivery__name').append(`<i class="delivery__point">${oscop.vars.pickupPoint}</i>`);oscop.toplayer(false);});return true;};return{vars,txt,init,};}());