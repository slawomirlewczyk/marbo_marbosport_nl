
const OpinionsShop=function OpinionsShop(params){const that=this;this.params=params;this.vars={opinions:document.getElementById('opinions_shop'),opinionSorters:document.querySelectorAll('.opinions_shop__sort'),opinionContent:document.querySelector('.opinions_shop__block.--opinions'),opinionWrapper:document.querySelector('.opinions_shop__wrapper'),opinionSkeleton:document.querySelector('.opinions_shop__opinion.--skeleton').outerHTML,moreSkeleton:document.querySelector('.opinions_shop__more_wrapper.--skeleton').outerHTML,blockAjaxFetch:false,};this.fetchData=async(dataFetch)=>{if(this.vars.blockAjaxFetch)return false;this.vars.blockAjaxFetch=true;this.vars.opinions.classList.add('load-content');if(dataFetch.join('')!==''&&sessionStorage.getItem(dataFetch.join('')))return JSON.parse(sessionStorage.getItem(dataFetch.join('')));if(dataFetch.join('')===''&&sessionStorage.getItem('allOpinionsShop'))return JSON.parse(sessionStorage.getItem('allOpinionsShop'));try{const response=await fetch(`/ajax/opinions.php?action=get&type=order${dataFetch.join('')}`);const dataJson=await response.json();if(dataFetch.join('')!=='')sessionStorage.setItem(dataFetch.join(''),JSON.stringify(dataJson));else sessionStorage.setItem('allOpinionsShop',JSON.stringify(dataJson))
return dataJson;}catch(error){console.error('AJAX fetchData() Error:',error);return false;}};this.buildHtmlOpinion=(json)=>{const currOpinion=document.querySelectorAll('.opinions_shop__opinion.--skeleton')[0];currOpinion.setAttribute('data-rate',json.rating);currOpinion.setAttribute('data-usefull',json.scorePositive);currOpinion.setAttribute('data-lang',json.language);currOpinion.setAttribute('data-opinion_id',json.id);if(json.rating>0.5){currOpinion.querySelectorAll('.opinions_shop__opinion_note i')[0].classList.add('--active');}
if(json.rating>1.5){currOpinion.querySelectorAll('.opinions_shop__opinion_note i')[1].classList.add('--active');}
if(json.rating>2.5){currOpinion.querySelectorAll('.opinions_shop__opinion_note i')[2].classList.add('--active');}
if(json.rating>3.5){currOpinion.querySelectorAll('.opinions_shop__opinion_note i')[3].classList.add('--active');}
if(json.rating>4.5){currOpinion.querySelectorAll('.opinions_shop__opinion_note i')[4].classList.add('--active');}
currOpinion.querySelector('.opinions_shop__opinion_score').innerHTML=`${json.rating}/5`;currOpinion.querySelector('.opinions_shop__date').innerHTML=json.createDate.match(/\d{4}-\d{2}-\d{2}/g);currOpinion.querySelector('.opinions_shop__text').innerHTML=json.content;currOpinion.querySelector('.opinions_shop__author').innerHTML=json.author;currOpinion.querySelector('.opinions_shop__thumbs.--up .opinions_shop__rate_count').innerHTML=json.scorePositive;currOpinion.querySelector('.opinions_shop__thumbs.--down .opinions_shop__rate_count').innerHTML=json.scoreNegative;if(json.answer!==''){currOpinion.querySelector('.opinions_shop__response_date').innerHTML=json.answerDatetime.match(/\d{4}-\d{2}-\d{2}/g);currOpinion.querySelector('.opinions_shop__response_bottom').innerHTML=json.answer;}else{currOpinion.removeChild(currOpinion.querySelector('.opinions_shop__response'));}
currOpinion.classList.remove('--skeleton');};this.buildHtmlNextPage=(json)=>{if(document.querySelector('.opinions_shop__more_wrapper:not(.--skeleton)')){this.vars.opinionContent.removeChild(this.vars.opinionContent.querySelector('.opinions_shop__more_wrapper:not(.--skeleton)'));}
if(((json.resultsPage+1)*json.resultsLimit)<json.resultsNumberAll){this.vars.opinionWrapper.insertAdjacentHTML('afterend',this.vars.moreSkeleton);const currMore=document.querySelectorAll('.opinions_shop__more_wrapper.--skeleton')[0];currMore.querySelector('.opinions_shop__more').setAttribute('data-page',json.resultsPage);currMore.querySelector('.opinions_shop__more').setAttribute('data-limited',json.resultsLimit);currMore.querySelector('.opinions_shop__more').setAttribute('data-all',json.resultsNumberAll);currMore.querySelector('span').innerHTML=((json.resultsNumberAll-((json.resultsPage+1)*json.resultsLimit))<json.resultsLimit)?json.resultsNumberAll-((json.resultsPage+1)*json.resultsLimit):json.resultsLimit;currMore.classList.remove('--skeleton');}};this.updateOpinions=async(nextPage)=>{const dataFetch=[];this.vars.opinionSorters.forEach((el)=>{if(el.classList.contains('--active'))dataFetch.push(`&rating[]=${el.getAttribute('data-rate')}`);});if(nextPage)dataFetch.push(`&resultsPage=${parseInt(nextPage.getAttribute('data-page'),10)+1}`);await this.fetchData(dataFetch).then((opinionData)=>{this.vars.opinions.classList.remove('load-content');this.vars.blockAjaxFetch=false;if(opinionData.results&&opinionData.results.length){this.vars.opinionContent.classList.remove('--empty');if(!nextPage)this.vars.opinionWrapper.innerHTML='';opinionData.results.forEach((el)=>{this.vars.opinionWrapper.innerHTML+=this.vars.opinionSkeleton;this.buildHtmlOpinion(el);});this.buildHtmlNextPage(opinionData);this.initEventsReload();}else if(opinionData.errors&&!opinionData.errors.length){this.vars.opinionContent.classList.add('--empty');this.vars.opinionWrapper.innerHTML='';this.vars.opinionContent.removeChild(this.vars.opinionContent.querySelector('.opinions_shop__more_wrapper:not(.--skeleton)'));}else{console.error(`faultCode:${opinionData.errors[0].faultCode}\nfaultString:${opinionData.errors[0].faultString}`);}
if(!nextPage&&app_shop.vars.view>2)$('html, body').animate({scrollTop:$('#opinions_shop').offset().top-this.headerHeight},500);});};this.usefull=(el)=>{const opinionParent=el.closest('.opinions_shop__opinion');const opinionId=opinionParent.getAttribute('data-opinion_id');const opinionPositive=(el.classList.contains('--up'))?'positive':'negative';fetch('/ajax/opinions.php?action=rate',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded',},body:`id=${opinionId}&operation=${opinionPositive}`,}).then((response)=>response.json()).then((data)=>{if(Object.keys(data.errors).length){console.error(`faultCode:${data.errors.faultCode}\nfaultString:${data.errors.faultString}`);Alertek.Start(data.errors.faultString);}
if(data.result){opinionParent.querySelector('.opinions_shop__thumbs.--up .opinions_shop__rate_count').innerHTML=data.result.score_positive;opinionParent.querySelector('.opinions_shop__thumbs.--down .opinions_shop__rate_count').innerHTML=data.result.score_negative;sessionStorage.clear();}}).catch((error)=>{console.error('AJAX usefull() Error:',error);});};this.initEvents=()=>{this.vars.opinionSorters.forEach((el)=>{el.addEventListener('click',function opinionSortersClick(e){e.preventDefault();if(!that.vars.blockAjaxFetch){this.classList.toggle('--active');that.updateOpinions();}});});};this.initEventsReload=()=>{const opinionUsefull=document.querySelectorAll('.opinions_shop__thumbs');opinionUsefull.forEach((el)=>{el.addEventListener('click',function opinionUsefullClick(e){e.preventDefault();if(!that.vars.blockAjaxFetch){that.usefull(this);}});});const opinionNextPage=document.getElementById('more_opinion');if(opinionNextPage){opinionNextPage.addEventListener('click',function opinionNextPageClick(e){e.preventDefault();if(!that.vars.blockAjaxFetch){that.updateOpinions(this);}});}};this.init=()=>{const{header,}=this.params;this.headerHeight=header||0;this.initEvents();this.initEventsReload();};return this.init();};